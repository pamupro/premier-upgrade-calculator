<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Premier Upgrade Calculator</title>
<style>
  :root{--bg:#05070d;--panel:#0c1220;--panel2:#0e1626;--muted:#9fb0c7;--text:#e9f1ff;--brand:#72b7ff;--brand2:#3aa9ff;--ok:#55d88a;--warn:#ffcc66;--danger:#ff6b6b}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(80% 60% at 70% 0%,#0f1c34 0,#070b14 40%,#05070d 100%) fixed;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 8px 24px rgba(58,169,255,.25)}
  h1{font-size:clamp(22px,3.2vw,30px);margin:0}
  .sub{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1.15fr 1fr;gap:16px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
  .card h2{font-size:16px;margin:0 0 10px;color:#cfe4ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:760px){.row{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0 6px}
  input,select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.06);color:var(--text)}
  select,option{color:#fff;background:rgba(20,28,44,.95)}
  input[type="range"]{padding:0}
  .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{padding:5px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);margin:12px 0}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{appearance:none;border:none;border-radius:10px;padding:11px 14px;font-weight:600;cursor:pointer}
  .b-primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#031023}
  .b-secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.12)}
  .b-ghost{background:transparent;color:var(--muted);border:1px dashed rgba(255,255,255,.2)}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:1000px){.stats{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.stats{grid-template-columns:1fr}}
  .stat{padding:14px;border-radius:14px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .stat small{display:block;color:var(--muted)}
  .stat strong{font-size:22px}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .flag{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:12px}
  .flag.ok{background:rgba(85,216,138,.08);border:1px solid rgba(85,216,138,.25);color:var(--ok)}
  .flag.no{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.25);color:var(--danger)}
  .footer{opacity:.8;font-size:12px;margin-top:8px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="mark"></div>
    <div>
      <h1>Premier Upgrade Calculator</h1>
      <div class="sub">Public-vs-booked · Fixed desk sheet · Custom · 10% commission for Premier</div>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Stay & Pricing</h2>
      <div class="row">
        <div><label>Check-in</label><input type="date" id="ci"/></div>
        <div><label>Check-out</label><input type="date" id="co"/></div>
      </div>
      <div class="row">
        <div><label>Nights (auto)</label><input type="number" id="nights" min="1" value="5"/></div>
        <div><label>Currency</label><select id="cur"><option>GBP £</option></select></div>
      </div>
      <div class="row">
        <div><label>From (Booked room)</label><select id="from"></select></div>
        <div><label>To (Premier target)</label><select id="to"></select></div>
      </div>
      <div class="row">
        <div><label>Booked total (for stay)</label><input id="bookedTotal" type="number" step="0.01" value="491"/></div>
        <div><label>Booked avg / night (auto)</label><input id="bookedAvg" type="number" step="0.01" disabled/></div>
      </div>

      <div class="hr"></div>
      <h2>Price basis</h2>
      <div class="inline" style="margin-bottom:10px">
        <span class="chip"><label class="inline"><input type="radio" name="basis" value="difference" checked> Public rate difference</label></span>
        <span class="chip"><label class="inline"><input type="radio" name="basis" value="fixed"> Fixed hotel rate (desk sheet)</label></span>
        <span class="chip"><label class="inline"><input type="radio" name="basis" value="custom"> Enter final extra</label></span>
      </div>

      <!-- Public difference -->
      <div id="pane-diff" class="card" style="padding:12px;margin-bottom:10px">
        <div class="row">
          <div><label>Public Premier total (Booking.com)</label><input id="publicTotal" type="number" step="0.01" value="811"/></div>
          <div><label>Discount % (off the difference)</label><input id="diffPct" type="range" min="0" max="50" value="0" oninput="this.nextElementSibling.value=this.value+'%'"/><output>0%</output></div>
        </div>
        <div class="btns"><button class="b-secondary" id="liveBtn" type="button">Fetch Live (Booking.com API)</button></div>
      </div>

      <!-- Fixed sheet -->
      <div id="pane-fixed" class="card" style="display:none;padding:12px;margin-bottom:10px">
        <div class="row">
          <div><label>Fixed £ / night (from sheet)</label><input id="fixedPN" type="number" step="0.01" value="0" disabled/></div>
          <div><label>Discount % (manager)</label><input id="fixedPct" type="range" min="0" max="50" value="0" oninput="this.nextElementSibling.value=this.value+'%'"/><output>0%</output></div>
        </div>
        <div class="footer" id="fixedNote"></div>
      </div>

      <!-- Custom -->
      <div id="pane-custom" class="card" style="display:none;padding:12px;margin-bottom:10px">
        <div class="row">
          <div><label>Final extra (total)</label><input id="customExtra" type="number" step="0.01" value="200"/></div>
          <div><label>Note</label><input id="note" type="text" placeholder="Manager approved / Busy night"/></div>
        </div>
      </div>

      <div class="btns">
        <button class="b-primary" id="calc">Calculate</button>
        <button class="b-secondary" id="print" type="button">Print / PDF</button>
        <button class="b-ghost" id="reset" type="button">Reset</button>
      </div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div class="inline" id="flag"></div>
      <div class="stats" style="margin-top:10px">
        <div class="stat"><small>Extra before discount</small><strong class="mono" id="s_before">£0.00</strong></div>
        <div class="stat"><small>Discount applied</small><strong class="mono" id="s_disc">£0.00</strong></div>
        <div class="stat"><small>Guest pays (final extra)</small><strong class="mono" id="s_final">£0.00</strong></div>
        <div class="stat"><small>Your commission (10%)</small><strong class="mono" id="s_comm">£0.00</strong></div>
        <div class="stat"><small>Effective target total</small><strong class="mono" id="s_effective">£0.00</strong></div>
        <div class="stat"><small>Savings vs public target</small><strong class="mono" id="s_save">£0.00</strong></div>
      </div>
      <div class="hr"></div>
      <div class="stats">
        <div class="stat"><small>Extra per night</small><strong class="mono" id="s_pn">£0.00</strong></div>
        <div class="stat"><small>Booked avg / night</small><strong class="mono" id="s_bookedAvg">£0.00</strong></div>
        <div class="stat"><small>Target avg / night (effective)</small><strong class="mono" id="s_targetAvg">£0.00</strong></div>
      </div>
      <div class="footer" id="publicInfo"></div>
    </div>
  </div>

  <div class="footer">Past dates disabled. Commission applies only for Premier targets (PS, PD, PTWN, PTRP, PQUAD, PK).</div>
</div>

<script>
(function(){
  const premier = new Set(['PS','PD','PTWN','PTRP','PQUAD','PK']);
  const nonPremier = new Set(['CS','CD','CT','DD','CTRP','CQUAD','SUITE']);
  const rooms = [
    ['CS','Classic Single'],['CD','Classic Double'],['CT','Classic Twin'],
    ['DD','Deluxe Double'],['CTRP','Classic Triple'],['CQUAD','Classic Quad'],
    ['SUITE','Suite'],['PS','Premier Single'],['PD','Premier Double'],
    ['PTWN','Premier Twin'],['PTRP','Premier Triple'],['PQUAD','Premier Quad'],['PK','Premier King']
  ];
  const $=id=>document.getElementById(id), £=n=>'£'+(isFinite(n)?n:0).toFixed(2);

  // Disable past dates; preselect today→+5 nights
  const today=new Date(), toYMD=d=>d.toISOString().slice(0,10);
  const ci=$('ci'), co=$('co'); ci.min=toYMD(today); co.min=toYMD(today);
  ci.valueAsDate=today; co.valueAsDate=new Date(today.getFullYear(),today.getMonth(),today.getDate()+5);

  // Populate selects (from=non-premier, to=premier)
  const from=$('from'), to=$('to');
  rooms.forEach(([v,t])=>{
    const o1=document.createElement('option');o1.value=v;o1.textContent=`${t} (${v})`;if(nonPremier.has(v)) from.appendChild(o1);
    const o2=document.createElement('option');o2.value=v;o2.textContent=`${t} (${v})`;if(premier.has(v)) to.appendChild(o2);
  });
  from.value='CD'; to.value='PD';

  // Nights & averages
  const nights=$('nights'), bookedTotal=$('bookedTotal'), bookedAvg=$('bookedAvg');
  function recalcNights(){ const d=(new Date(co.value)-new Date(ci.value))/86400000; nights.value=Math.max(1,Math.round(d)); }
  function syncBookedAvg(){ const n=Math.max(1,+nights.value||1); const t=+bookedTotal.value||0; bookedAvg.value=(t/n).toFixed(2); $('s_bookedAvg').textContent=£(t/n); }
  ci.addEventListener('change',recalcNights); co.addEventListener('change',recalcNights);
  nights.addEventListener('input',syncBookedAvg); bookedTotal.addEventListener('input',syncBookedAvg);
  recalcNights(); syncBookedAvg();

  // Fixed-rate mapping (per night) from your desk sheet
  const FR={
    CS:{PS:60,PD:90,PTWN:90,PTRP:150,PQUAD:180,PK:200},
    CD:{PS:40,PD:70,PTWN:70,PTRP:130,PQUAD:160,PK:180},
    CT:{PS:40,PD:70,PTWN:70,PTRP:130,PQUAD:160,PK:180},
    DD:{PS:20,PD:50,PTWN:50,PTRP:110,PQUAD:140,PK:160},
    CTRP:{PTRP:60,PQUAD:90,PK:110},
    CQUAD:{PS:30,PTRP:60,PQUAD:90,PK:110},
    SUITE:{PQUAD:40,PK:60}
  };
  function fixedRate(f,t){ const m=FR[f]||{}; if(m[t]!=null) return m[t]; if(t==='PD'||t==='PTWN') return m.PD??m.PTWN??0; return 0; }

  // Basis panes
  function showBasis(){
    const v=document.querySelector('input[name="basis"]:checked').value;
    $('pane-diff').style.display = v==='difference' ? '' : 'none';
    $('pane-fixed').style.display = v==='fixed' ? '' : 'none';
    $('pane-custom').style.display = v==='custom' ? '' : 'none';
  }
  document.querySelectorAll('input[name="basis"]').forEach(r=>r.addEventListener('change',showBasis));
  showBasis();

  // Update fixed rate when rooms change
  function updateFixed(){
    const r=fixedRate(from.value,to.value);
    $('fixedPN').value=r;
    $('fixedNote').textContent = r ? '' : 'No fixed rate for this pair on the desk sheet.';
  }
  from.addEventListener('change',updateFixed); to.addEventListener('change',updateFixed); updateFixed();

  // Live rates (optional backend at /api/booking)
  async function fetchLive(){
    const params=new URLSearchParams({checkin:ci.value,checkout:co.value,adults:'2'});
    try{
      const res=await fetch(`/api/booking?${params.toString()}`);
      if(!res.ok) throw new Error('API error');
      const data=await res.json();
      if(data?.premierTotal!=null){ $('publicTotal').value=Number(data.premierTotal).toFixed(2); }
      document.querySelector('input[name="basis"][value="difference"]').checked=true; showBasis();
      calc();
    }catch(e){ alert('Could not fetch live rates. Enter public total manually.'); }
  }
  $('liveBtn').addEventListener('click',fetchLive);

  // Results calc
  function calc(){
    const n=Math.max(1,+nights.value||1), bT=+bookedTotal.value||0;
    const basis=document.querySelector('input[name="basis"]:checked').value;
    let base=0, disc=0, final=0;

    if(basis==='difference'){
      const pub=+$('publicTotal').value||0;
      base=Math.max(0,pub-bT);
      disc=base*((+$('diffPct').value||0)/100);
      final=Math.max(0,base-disc);
      $('publicInfo').textContent = pub ? `Public target total: ${£(pub)}` : '';
    } else if(basis==='fixed'){
      const perN=fixedRate(from.value,to.value);
      base=perN*n;
      disc=base*((+$('fixedPct').value||0)/100);
      final=Math.max(0,base-disc);
      $('publicInfo').textContent='';
    } else { // custom
      final=Math.max(0,+$('customExtra').value||0);
      base=final; disc=0; $('publicInfo').textContent='';
    }

    const eff=bT+final, extraPN=final/n, isPremierTarget=premier.has(to.value);
    const comm=isPremierTarget? final*0.10 : 0;
    const pubT=+$('publicTotal').value||0, save=pubT? Math.max(0,pubT-eff):0;

    $('s_before').textContent=£(base);
    $('s_disc').textContent=£(disc);
    $('s_final').textContent=£(final);
    $('s_comm').textContent=£(comm);
    $('s_effective').textContent=£(eff);
    $('s_save').textContent=£(save);
    $('s_pn').textContent=£(extraPN);
    $('s_targetAvg').textContent=£(eff/n);

    $('flag').innerHTML = isPremierTarget
      ? '<span class="flag ok">Premier upgrade — commission eligible</span>'
      : '<span class="flag no">Not commission eligible</span>';
  }

  $('calc').addEventListener('click',calc);
  $('print').addEventListener('click',()=>window.print());
  $('reset').addEventListener('click',()=>window.location.reload());

  calc();
})();
</script>
</body>
</html>
